{% extends "main.html" %}

{% block content %}
<section class='section-main d-flex flex-column justify-content-start align-items-center container-fluid p-4'>

    <!-- TÍTULO PRINCIPAL -->
    <h1 class="log-in h1">Analítica y Reportes del HIS+</h1>
    <h3 class="log-in h3 mb-5">Indicadores clave de rendimiento y atención médica</h3>

    <!-- MENSAJES -->
    {% if messages %}
        {% for m in messages %}
        <div class="alert alert-{{ m.tags }} alert-dismissible fade show w-75" role="alert">
            {{ m }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    {% endif %}

    <!-- GRUPO 1: INDICADORES DE TIEMPO Y ESTADO -->
    <div class="row w-100 g-4 mb-5">
        
        <!-- CARD 1: TIEMPO PROMEDIO DE DIAGNÓSTICO -->
        <div class="col-md-6">
            <div class="card shadow-lg h-100 border-start border-primary border-5">
                <div class="card-body">
                    <h5 class="card-title text-primary"><i class="bi bi-clock-history me-2"></i> Tiempo Promedio de Atención</h5>
                    <p class="card-text text-muted small">Tiempo transcurrido desde la hora de la cita hasta el registro del diagnóstico (Citas REALIZADAS).</p>
                    <div class="display-4 fw-bold text-center mt-3">
                        {% if tiempo_promedio %}
                            {{ tiempo_promedio|floatformat:"-1" }}
                            <small class="h6 text-muted">días (estimado)</small> 
                            <!-- Nota: En Django esto es un timedelta. Aquí se muestra una representación simple -->
                        {% else %}
                            <span class="text-secondary">N/D</span>
                        {% endif %}
                    </div>
                    <div class="text-center text-secondary small mt-2">
                        <i class="bi bi-info-circle"></i> Consulta 3 del Requerimiento
                    </div>
                </div>
            </div>
        </div>

        <!-- CARD 2: CITAS POR ESTADO -->
        <div class="col-md-6">
            <div class="card shadow-lg h-100 border-start border-warning border-5">
                <div class="card-body">
                    <h5 class="card-title text-warning"><i class="bi bi-bar-chart-fill me-2"></i> Total de Citas por Estado</h5>
                    <p class="card-text text-muted small">Distribución actual de todas las citas registradas en el sistema.</p>
                    <ul class="list-group list-group-flush mt-3">
                        {% for estado in citas_por_estado %}
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            {{ estado.estado }}
                            <span class="badge bg-secondary rounded-pill">{{ estado.total }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- GRUPO 2: TOP MÉDICOS -->
    <div class="identification w-100 p-4 mb-5 bg-white shadow-lg rounded-3">
        <h4 class="log_title mb-4 border-bottom pb-2 text-success"><i class="bi bi-award-fill me-2"></i> Ranking de Productividad Médica</h4>
        <p class="text-muted small">Médicos con mayor número de consultas **atendidas** (estado REALIZADA) en la última semana.</p>

        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-success table-opacity-75">
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Nombre del Médico</th>
                        <th scope="col">Rol</th>
                        <th scope="col" class="text-center">Citas Atendidas (Última Semana)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for medico in medicos_top %}
                    <tr>
                        <th scope="row">{{ forloop.counter }}</th>
                        <td>{{ medico.nombre }} {{ medico.apellido }}</td>
                        <td>{{ medico.rol }}</td>
                        <td class="text-center"><span class="badge bg-success rounded-pill">{{ medico.conteo }}</span></td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center py-3">No hay datos de consultas realizadas en la última semana.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="text-secondary small mt-2 text-end">
            <i class="bi bi-info-circle"></i> Consulta 2 del Requerimiento
        </div>
    </div>
    
    <!-- ENLACE A ANALÍTICA DE MEDICAMENTOS -->
    <div class="w-100 text-center">
        <a href="{% url 'cashier:analitica_medicamentos' %}" class="btn btn-secondary btn-lg">
            <i class="bi bi-capsule me-2"></i> Ver Reporte de Consumo de Medicamentos
        </a>
    </div>

</section>
{% endblock content %}