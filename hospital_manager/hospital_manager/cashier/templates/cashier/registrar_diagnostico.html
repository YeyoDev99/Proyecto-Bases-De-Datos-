{% extends "main.html" %}

{% block content %}
<section class='section-main d-flex flex-column justify-content-start align-items-center container-fluid p-4'>

    <!-- TÍTULO PRINCIPAL -->
    <h1 class="log-in h1">Registro de Historia Clínica</h1>
    <h3 class="log-in h3 mb-4">Diagnóstico Médico (Cita #{{ cita.pk }})</h3>

    <!-- MENSAJES -->
    {% if messages %}
        {% for m in messages %}
        <div class="alert alert-{{ m.tags }} alert-dismissible fade show w-75" role="alert">
            {{ m }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    {% endif %}

    <!-- DETALLES DEL PACIENTE Y CITA -->
    <div class="identification w-75 p-4 mb-5 bg-white shadow-lg">
        <h4 class="log_title mb-3">Información del Paciente</h4>
        <div class="row text mb-3">
            <div class="col-md-6">
                <p><strong>Paciente:</strong> {{ paciente.first_name }} {{ paciente.last_name }}</p>
                <p><strong>Documento:</strong> {{ paciente.num_doc }} ({{ paciente.tipo_doc }})</p>
            </div>
            <div class="col-md-6">
                <p><strong>Servicio:</strong> {{ cita.tipo_servicio }}</p>
                <p><strong>Fecha/Hora Cita:</strong> {{ cita.fecha_hora|date:"d M Y H:i" }}</p>
            </div>
        </div>
        
        <hr class="my-4">
        
        <!-- FORMULARIO DE DIAGNÓSTICO -->
        <h4 class="log_title mb-4">Registro de Diagnóstico</h4>
        
        <form method="POST" action="{% url 'cashier:registrar_diagnostico' cita.pk %}" class="row g-4">
            {% csrf_token %}
            
            <!-- Campo para el motivo de consulta/anamnesis (si existe en el form) -->
            {% for field in form %}
                {% if field.name == 'diagnostico' or field.name == 'notas_medicas' or field.name == 'motivo_consulta' %}
                    <div class="col-12">
                        <label for="{{ field.id_for_label }}" class="title form-label">{{ field.label }}</label>
                        {{ field }}
                        {% if field.errors %}
                            <small class="text-danger">{{ field.errors }}</small>
                        {% endif %}
                    </div>
                {% else %}
                    <!-- Otros campos de la Historia Clínica si los hubiera (ej: peso, talla, presión) -->
                    <div class="col-md-6">
                        <label for="{{ field.id_for_label }}" class="title form-label">{{ field.label }}</label>
                        {{ field }}
                        {% if field.errors %}
                            <small class="text-danger">{{ field.errors }}</small>
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}

            <div class="col-12 mt-5 text-center">
                <button type="submit" class="btn btn-primary btn-lg me-3">
                    <i class="bi bi-save me-1"></i> Guardar y Continuar a Prescripción
                </button>
                <a href="{% url 'cashier:citas_pendientes' %}" class="btn btn-outline-secondary btn-lg">
                    <i class="bi bi-x-circle me-1"></i> Cancelar / Volver a Agenda
                </a>
            </div>
        </form>
    </div>

</section>
{% endblock content %}