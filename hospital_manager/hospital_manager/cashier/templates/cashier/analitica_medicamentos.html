{% extends "main.html" %}

{% block content %}
<section class='section-main d-flex flex-column justify-content-start align-items-center container-fluid p-4'>

    <!-- TÍTULO PRINCIPAL -->
    <h1 class="log-in h1">Análisis de Consumo de Medicamentos</h1>
    <h3 class="log-in h3 mb-5">Medicamentos más recetados por Sede (Últimos 30 días)</h3>

    <!-- MENSAJES -->
    {% if messages %}
        {% for m in messages %}
        <div class="alert alert-{{ m.tags }} alert-dismissible fade show w-75" role="alert">
            {{ m }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    {% endif %}

    <!-- CONTENEDOR DE LA TABLA -->
    <div class="identification w-100 p-4 mb-5 bg-white shadow-lg rounded-3">
        <h4 class="log_title mb-4 border-bottom pb-2 text-info"><i class="bi bi-hospital me-2"></i> Top Recetas por Sede</h4>
        <p class="text-muted small">Este informe es crucial para la gestión de inventario distribuido y optimización de compras.</p>

        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-info table-opacity-75">
                    <tr>
                        <th scope="col">Sede Hospitalaria</th>
                        <th scope="col">Medicamento</th>
                        <th scope="col" class="text-center">Total de Recetas</th>
                    </tr>
                </thead>
                <tbody>
                    {% regroup medicamentos_top by sede as sedes_list %}
                    
                    {% for sede_group in sedes_list %}
                        {% with count=sede_group.list|length %}
                        {% for item in sede_group.list %}
                            <tr>
                                {% if forloop.first %}
                                <td rowspan="{{ count }}" class="align-middle fw-bold bg-light" style="vertical-align: middle;">{{ sede_group.grouper }}</td>
                                {% endif %}
                                <td>{{ item.medicamento }}</td>
                                <td class="text-center"><span class="badge bg-info rounded-pill">{{ item.total_recetas }}</span></td>
                            </tr>
                        {% endfor %}
                        {% endwith %}
                    {% empty %}
                    <tr>
                        <td colspan="3" class="text-center py-4">No se han registrado recetas en el último mes para generar este reporte.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="text-secondary small mt-2 text-end">
            <i class="bi bi-info-circle"></i> Consulta 1 del Requerimiento
        </div>
    </div>

</section>
{% endblock content %}